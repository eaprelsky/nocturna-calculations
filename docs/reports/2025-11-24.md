# Bug Report: Synastry/Transit Endpoint Missing or Returns 404 [RESOLVED]

## Environment
- **API**: nocturna-calculations
- **API URL**: https://calculations.nocturna.ru/api
- **Client**: nocturna-tg Telegram Bot
- **Date**: 2025-11-23
- **Resolution Date**: 2025-11-24

## Issue Description

The `/charts/{chart_id}/synastry` endpoint returns **404 Not Found** when attempting to calculate synastry/transits between two charts.

## Resolution

**Status:** ✅ **RESOLVED**

The following endpoints have been implemented:

1. **Synastry Endpoint**: `POST /api/charts/{chart_id}/synastry`
   - Compares two natal charts
   - Returns aspects between planets from both charts
   - Provides compatibility metrics and strength scores

2. **Transit Endpoint**: `POST /api/charts/{chart_id}/transits`
   - Calculates current planetary transits to natal chart
   - Returns transiting planet positions
   - Shows aspects between transiting and natal planets

**Changes Made:**
- Added `SynastryRequest` and `SynastryResponse` schemas
- Added `TransitRequest` and `TransitResponse` schemas
- Implemented `/api/charts/{chart_id}/synastry` endpoint
- Implemented `/api/charts/{chart_id}/transits` endpoint
- Updated API documentation with detailed endpoint specifications
- Updated API reference documentation

## Expected Behavior

The API should support synastry calculations:

```typescript
// Chart-based synastry calculation
const synastry = await ChartApiService.calculateChartSynastry(chartId, {
  target_chart_id: 'other-chart-id'  // ✅ Correct parameter name
});
```

**Note**: Original third-party documentation incorrectly referenced `second_chart_id`. 
The correct parameter name is `target_chart_id` as implemented in the API.

This functionality is essential for:
1. **Synastry analysis**: Comparing two natal charts for compatibility
2. **Personal transits**: Calculating aspects between current planetary positions and natal chart
3. **Composite charts**: Creating relationship charts

## Actual Behavior

API returns:
```
404 Client Error: Not Found for url: https://calculations.nocturna.ru/api/charts/{chart_id}/synastry
Response: {'detail': 'Not Found'}
```

## Reproduction Steps

1. Create natal chart via `POST /charts`:
```python
natal_chart = client.create_chart(
    date='1985-03-10',
    time='01:34:00',
    latitude=55.0288307,
    longitude=82.9226887,
    timezone='Asia/Novosibirsk'
)
natal_chart_id = natal_chart['id']  # Returns: '9bb8c84d-4d7a-4c3d-a099-c10d53392909'
```

2. Create transit/comparison chart via `POST /charts`:
```python
transit_chart = client.create_chart(
    date='2025-11-23',
    time='21:21:47',
    latitude=55.0288307,
    longitude=82.9226887,
    timezone='Asia/Novosibirsk'
)
transit_chart_id = transit_chart['id']  # Returns: '448a4760-062b-4de6-bd37-54c43e22557a'
```

3. Attempt synastry calculation via `POST /charts/{chart_id}/synastry`:
```python
synastry = client.calculate_synastry(
    chart_id=natal_chart_id,
    target_chart_id=transit_chart_id,
    aspects=["CONJUNCTION", "OPPOSITION", "TRINE", "SQUARE", "SEXTILE"],
    orb_multiplier=1.0
)
# Returns: 404 Not Found
```

## Log Evidence

```
2025-11-23 21:21:47,528 - urllib3.connectionpool - DEBUG - https://calculations.nocturna.ru:443 "POST /api/charts/9bb8c84d-4d7a-4c3d-a099-c10d53392909/synastry HTTP/1.1" 404 22
2025-11-23 21:21:47,529 - src.api.nocturna_client - ERROR - Client error 404: 404 Client Error: Not Found for url: https://calculations.nocturna.ru/api/charts/9bb8c84d-4d7a-4c3d-a099-c10d53392909/synastry
API Response: {'detail': 'Not Found'}
```

## Current Implementation

### NocturnaClient (src/api/nocturna_client.py)

```python
def calculate_synastry(
    self,
    chart_id: str,
    target_chart_id: str,
    aspects: Optional[List[str]] = None,
    orb_multiplier: float = 1.0,
) -> Dict[str, Any]:
    """Calculate synastry between two charts."""
    payload = {
        "target_chart_id": target_chart_id,
        "orb_multiplier": orb_multiplier,
    }
    
    if aspects:
        payload["aspects"] = aspects
    
    response = self._make_request(
        "POST", f"/charts/{chart_id}/synastry", json=payload
    )
    
    if "success" in response:
        if response.get("success"):
            return response.get("data", {})
        else:
            error = response.get("error", {})
            raise NocturnaAPIError(f"API error: {error.get('message', 'Unknown error')}")
    else:
        return response
```

## Possible Solutions

### Option 1: Implement Missing Endpoint (Preferred)

Add `/charts/{chart_id}/synastry` endpoint to nocturna-calculations API:

```python
@router.post("/charts/{chart_id}/synastry")
async def calculate_synastry(
    chart_id: str,
    request: SynastryRequest,
    # ... authentication ...
):
    """
    Calculate synastry/transits between two charts.
    
    Returns aspects between planets in chart_id (natal) and 
    planets in target_chart_id (transit/comparison).
    """
    # Get both charts from storage
    chart1 = get_chart(chart_id)
    chart2 = get_chart(request.target_chart_id)
    
    # Calculate aspects between chart1 planets and chart2 planets
    aspects = calculate_aspects_between_charts(
        chart1.positions,
        chart2.positions,
        aspects=request.aspects,
        orb_multiplier=request.orb_multiplier
    )
    
    return {"aspects": aspects}
```

### Option 2: Alternative Endpoint Name

If the endpoint exists under a different name, please document:
- Correct endpoint URL
- Expected request format
- Response format

### Option 3: Direct Calculation Endpoint

Add a direct calculation endpoint that doesn't require chart storage:

```python
@router.post("/calculations/transits")
async def calculate_transits(
    natal_positions: List[PlanetaryPosition],
    transit_date: datetime,
    transit_location: Location,
    # ... other params ...
):
    """Calculate transits to natal positions."""
    # Calculate current positions
    transit_positions = calculate_positions(transit_date, transit_location)
    
    # Calculate aspects between natal and transit
    aspects = calculate_aspects_between_positions(natal_positions, transit_positions)
    
    return {"transit_positions": transit_positions, "aspects": aspects}
```

## Impact

This missing functionality blocks:
- **Personal transit analysis** in Telegram bot
- **Synastry/compatibility readings**
- **Composite chart calculations**
- **Progressive/directed chart comparisons**

## Workaround

Currently no workaround available without implementing aspect calculations client-side, which would:
- Duplicate API logic
- Risk calculation inconsistencies
- Increase maintenance burden
- Reduce code quality

## Request

Please implement one of the solutions above to enable synastry/transit calculations via the API.

## Related Documentation

- `third-party-docs/nocturna-saas-backend/docs/integrations/nocturna-calculations-integration.md` (lines 254-257)
- Current implementation: `src/api/nocturna_client.py` (lines 429-467)
- Service using this: `src/services/personal_transit_service.py`

## Contact

- Project: nocturna-tg (Telegram Bot)
- Repository: [provide if public]
- Contact: [your contact info]

